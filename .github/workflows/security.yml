name: Security Scanning

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run weekly security scans
    - cron: '0 0 * * 0'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  # ==========================================================================
  # Python Security (SAST with Bandit)
  # ==========================================================================
  bandit:
    name: Python SAST (Bandit)
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Bandit
        run: pip install bandit[toml]

      - name: Run Bandit security scan
        run: |
          bandit -r backend/ \
            -f json \
            -o bandit-report.json \
            --severity-level medium \
            --confidence-level medium \
            -x '**/tests/**,**/__pycache__/**' \
            || true

      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit-report.json

      - name: Check for high severity issues
        run: |
          if [ -f bandit-report.json ]; then
            HIGH_COUNT=$(python -c "import json; data=json.load(open('bandit-report.json')); print(len([r for r in data.get('results', []) if r.get('issue_severity') == 'HIGH']))")
            echo "High severity issues: $HIGH_COUNT"
            if [ "$HIGH_COUNT" -gt "0" ]; then
              echo "::warning::Found $HIGH_COUNT high severity security issues"
            fi
          fi

  # ==========================================================================
  # Secret Scanning (Gitleaks)
  # ==========================================================================
  gitleaks:
    name: Secret Scanning (Gitleaks)
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_NOTIFY_USER_LIST: ""

  # ==========================================================================
  # Dependency Scanning
  # ==========================================================================
  dependency-check:
    name: Dependency Vulnerability Scan
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install pip-audit
        run: pip install pip-audit

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Run pip-audit
        run: |
          pip-audit \
            --format json \
            --output pip-audit-report.json \
            || true

      - name: Upload pip-audit report
        uses: actions/upload-artifact@v4
        with:
          name: pip-audit-report
          path: pip-audit-report.json

      - name: Check for critical vulnerabilities
        run: |
          if [ -f pip-audit-report.json ]; then
            VULN_COUNT=$(python -c "import json; data=json.load(open('pip-audit-report.json')); print(len([v for v in data if any(f.get('severity', '').upper() == 'CRITICAL' for f in v.get('vulns', []))]))")
            echo "Critical vulnerabilities: $VULN_COUNT"
            if [ "$VULN_COUNT" -gt "0" ]; then
              echo "::error::Found $VULN_COUNT critical vulnerabilities"
              exit 1
            fi
          fi

  # ==========================================================================
  # CodeQL Analysis
  # ==========================================================================
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v6

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python, javascript

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:python"

  # ==========================================================================
  # Security Headers Check
  # ==========================================================================
  security-headers:
    name: Security Headers Validation
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: pip install -r requirements-dev.txt

      - name: Run security header tests
        env:
          TESTING: "true"
        run: |
          pytest tests/test_security_headers.py -v --tb=short || echo "Security header tests not found (OK)"

  # ==========================================================================
  # License Compliance
  # ==========================================================================
  license-check:
    name: License Compliance
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install pip-licenses
        run: pip install pip-licenses

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Generate license report
        run: |
          pip-licenses \
            --format=json \
            --output-file=licenses.json

      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: licenses.json

      - name: Check for copyleft licenses
        run: |
          COPYLEFT=$(pip-licenses --format=csv | grep -iE "(GPL|AGPL|LGPL)" | wc -l)
          if [ "$COPYLEFT" -gt "0" ]; then
            echo "::warning::Found $COPYLEFT packages with copyleft licenses - review required"
          fi
