name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  TESTING: "true"
  ENVIRONMENT: "test"
  PYTHONPATH: ${{ github.workspace }}

jobs:
  tests:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
          pip install pytest-cov pytest-timeout

      - name: Run tests
        env:
          TESTING: "true"
          SKIP_REDIS: "true"
          SKIP_FHIR: "true"
        run: |
          pytest tests/ \
            -v \
            --tb=short \
            --timeout=60 \
            --ignore=tests/test_calendar_endpoints.py \
            --ignore=tests/test_calendar_integration.py \
            --ignore=tests/test_calendar_token_refresh.py \
            --ignore=tests/test_oauth_endpoints.py \
            --ignore=tests/test_health_check.py \
            --ignore=tests/test_region_integration.py \
            --ignore=tests/test_system_endpoints.py \
            --ignore=tests/test_e2e_user_flows.py \
            --ignore=tests/test_notifications.py \
            --ignore=tests/test_cache_utils.py \
            --ignore=tests/test_cache_controls.py \
            --ignore=tests/test_patient_endpoints.py \
            --ignore=tests/test_patient_analyzer_e2e.py \
            --ignore=tests/test_explainability.py \
            --ignore=tests/test_dashboard_endpoint.py \
            --ignore=tests/test_recommendation_service.py \
            --ignore=tests/test_fhir_http_client.py \
            --ignore=tests/test_fhir_resource_service.py \
            --ignore=tests/test_fhir_vendor_integrations.py \
            --ignore=tests/test_graph_visualization_endpoints.py \
            --ignore=tests/test_data_deletion.py \
            --ignore=tests/test_database.py \
            --ignore=tests/test_hl7_endpoints.py \
            --ignore=tests/test_route_contract.py \
            -k "not redis and not google_calendar and not fhir and not smtp and not llm_engine" \
            --cov=backend \
            --cov-report=xml:coverage.xml \
            --cov-report=html:htmlcov \
            --junitxml=pytest-results.xml

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: test-results
          path: |
            pytest-results.xml
            coverage.xml
            htmlcov/
            test-reports/
            htmlcov/
          retention-days: 7

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install linters
        run: pip install ruff

      - name: Run Ruff
        run: ruff check backend/ --output-format=github || true

  frontend-tests:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: react_frontend

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: react_frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test -- --run

      - name: Build
        run: npm run build

